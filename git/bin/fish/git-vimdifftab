#!/usr/bin/fish

function usage
    set -l usage \
"
USAGE:
    "(basename (status --current-filename))" [OPTION]
OPTIONS:
    -f, --fzf    Select files using fzf
    -h, --help   Display this help
    -n, --parent Get diff from `HEAD~{n}`
"
    echo $usage
end

argparse 'h/help' 'f/fzf' 'n/parent=' -- $argv
or exit 1

set -q _flag_help; and begin
    usage
    exit
end

set commitish
set -q _flag_parent; and set commitish "HEAD~$_flag_parent"

set diff_files (git diff --name-only --relative $commitish)
test (count $diff_files) -eq 0; and begin
    echo no diff found
    exit 0
end

test (count $diff_files) -ge 10; and set _flag_fzf '-f'

set -q _flag_fzf; and begin
    set diff_files (string split ' ' $diff_files | fzf)
    test (count $diff_files) -eq 0; and exit 0
end

echo $diff_files | xargs vim -p -c "tabdo Gdiffsplit $commitish"
